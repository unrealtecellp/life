{% extends "karyaextlinks.html" %}

{% block title %}
  Karya Extension
{% endblock title %}

{% block styles %}
  {{ super() }}
  <link href="{{ url_for('karya_bp.static', filename='home_insert.css') }}" rel="stylesheet" />
{% endblock %}

{% block app_content %}
  {% if projectName is defined %}
    <h4>
      Project Name : {{ projectName }}
    </h4>
  {% endif %}

  <div>
    <form id="otpForm">
      <div class="form-group">
        <label for="phoneNumber">Mobile Number:</label>
        <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" placeholder="Enter your mobile number">
      </div>
      <button type="button" id="getOtpBtn" class="btn btn-primary">Get OTP</button>

      <div id="otpInput" style="display:none;">
        <div class="form-group">
          <label for="otp">Enter OTP:</label>
          <input type="text" class="form-control" id="otp" name="otp" placeholder="Enter the OTP">
        </div>
        <button type="button" id="verifyOtpBtn" class="btn btn-success">Verify OTP</button>
      </div>
    </form>

    <div id="accessCodeDropdown" style="display:none;">
      <label for="accessCode">Select Access Code:</label>
      <select id="accessCode" class="form-control">
        <!-- Access codes will be populated here -->
      </select>
      <button type="button" id="fetchMicrotasksBtn" class="btn btn-secondary" style="margin-top: 10px;">Fetch Microtasks</button>
    </div>

    <div id="microtasksDisplay" style="display:none; margin-top: 20px;">
      <h4>Microtasks Information</h4>
      <ul id="microtasksList">
        <!-- Microtasks will be displayed here -->
      </ul>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="text/javascript">
    $(document).ready(function() {
        let otpId = '';  // Initialize a variable to store otp_id

        $('#getOtpBtn').on('click', function() {
            const phoneNumber = $('#phoneNumber').val();
            $.ajax({
                url: "{{ url_for('karya_bp.get_otp') }}",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ "phone_number": phoneNumber }),
                success: function(response) {
                    if (response.status === 200) {
                        otpId = response.otp_id;  // Store the received otp_id
                        $('#otpInput').show();
                    } else {
                        alert('Enter correct mobile number');
                    }
                },
                error: function() {
                    alert('Error occurred while requesting OTP.');
                }
            });
        });

        $('#verifyOtpBtn').on('click', function() {
            const phoneNumber = $('#phoneNumber').val();
            const otp = $('#otp').val();

            $.ajax({
                url: "{{ url_for('karya_bp.verify_otp') }}",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    "phone_number": phoneNumber,
                    "otp": otp,
                    "otp_id": otpId  // Use the stored otp_id
                }),
                success: function(response) {
                    if (response.status === 200) {
                        const token_id = response.token_id;  // Get token_id from the response
                        const accessCodes = response.access_codes;
                        const dropdown = $('#accessCode');

                        dropdown.empty(); // Clear any existing options
                        $.each(accessCodes, function(index, value) {
                            dropdown.append($('<option></option>').attr('value', value).text(value));
                        });

                        $('#accessCodeDropdown').show();  // Show the dropdown list

                        // Store token_id to use when fetching microtasks
                        $('#fetchMicrotasksBtn').data('token_id', token_id);
                    } else {
                        alert('Enter correct OTP');
                    }
                },
                error: function() {
                    alert('Error occurred while verifying OTP.');
                }
            });
        });

        $('#fetchMicrotasksBtn').on('click', function() {
            const accessCode = $('#accessCode').val();
            const token_id = $('#fetchMicrotasksBtn').data('token_id');  // Retrieve stored token_id

            $.ajax({
                url: "{{ url_for('karya_bp.get_microtasks') }}",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ "token_id": token_id, "access_code": accessCode }),
                success: function(response) {
                    const microtasks = response.microtasks;
                    const microtasksList = $('#microtasksList');

                    microtasksList.empty(); // Clear previous microtasks

                    if (microtasks && microtasks.length > 0) {
                        $.each(microtasks, function(index, task) {
                            const listItem = `
                                <li>
                                    <strong>Task ID:</strong> ${task.task_id} <br>
                                    <strong>Microtask ID:</strong> ${task.id} <br>
                                    <strong>Input Data Point ID:</strong> ${task.input_dp_id} <br>
                                    <strong>File:</strong> ${task.files.image} <br>
                                    <strong>Created At:</strong> ${task.created_at} <br>
                                    <strong>Last Updated At:</strong> ${task.last_updated_at} <br>
                                </li>
                                <hr>`;
                            microtasksList.append(listItem);
                        });

                        $('#microtasksDisplay').show();  // Show the microtasks section
                    } else {
                        microtasksList.append('<li>No microtasks found.</li>');
                        $('#microtasksDisplay').show();  // Show the microtasks section
                    }
                },
                error: function() {
                    alert('Error occurred while fetching microtasks.');
                }
            });
        });
    });  // End of $(document).ready function
  </script>
{% endblock %}
